<source>
  @type tail
  @id input_tail_app_logs
  @label @mainstream
  path /fluentd/log/*.log
  pos_file /fluentd/log/app.log.pos
  tag ai-soar.app.*
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%LZ
</source>

<source>
  @type tail
  @id input_tail_mcp_logs
  @label @mainstream
  path /fluentd/log/mcp-*.log
  pos_file /fluentd/log/mcp.log.pos
  tag ai-soar.mcp.*
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%LZ
</source>

<source>
  @type forward
  @id input_forward
  @label @mainstream
  port 24224
</source>

<filter ai-soar.**>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    service_name "${tag_parts[1]}"
    environment "production"
    project_id "svc-hackathon-prod07"
  </record>
</filter>

<label @mainstream>
  <match ai-soar.app.**>
    @type copy
    
    # Send to Google Cloud Logging
    <store>
      @type google_cloud
      project_id svc-hackathon-prod07
      zone us-central1-a
      vm_id ai-soar-vm
      use_metadata_service true
      <buffer>
        @type file
        path /fluentd/log/buffer/gcloud
        flush_thread_count 8
        flush_interval 5s
        chunk_limit_size 2M
        queue_limit_length 32
        retry_limit 3
        retry_wait 10s
        max_retry_wait 300s
      </buffer>
    </store>
    
    # Local backup
    <store>
      @type file
      @id output_file_app
      path /fluentd/log/backup/app.%Y%m%d
      append true
      time_slice_format %Y%m%d
      time_slice_wait 10m
      time_format %Y%m%dT%H%M%S%z
      format json
    </store>
  </match>

  <match ai-soar.mcp.**>
    @type copy
    
    # Send to Google Cloud Logging
    <store>
      @type google_cloud
      project_id svc-hackathon-prod07
      zone us-central1-a
      vm_id ai-soar-vm
      use_metadata_service true
      <buffer>
        @type file
        path /fluentd/log/buffer/gcloud-mcp
        flush_thread_count 8
        flush_interval 5s
        chunk_limit_size 2M
        queue_limit_length 32
        retry_limit 3
        retry_wait 10s
        max_retry_wait 300s
      </buffer>
    </store>
    
    # Local backup
    <store>
      @type file
      @id output_file_mcp
      path /fluentd/log/backup/mcp.%Y%m%d
      append true
      time_slice_format %Y%m%d
      time_slice_wait 10m
      time_format %Y%m%dT%H%M%S%z
      format json
    </store>
  </match>

  # Catch-all for unmatched logs
  <match **>
    @type stdout
    @id output_stdout
  </match>
</label>